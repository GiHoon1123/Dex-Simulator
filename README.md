# DEX Simulator

DEX 풀, LP, 트레이더 시뮬레이션을 위한 NestJS 기반 API 서버입니다.

## 기술 스택

- **Node.js**: 18.x 이상
- **NestJS**: 11.0.1
- **TypeScript**: 5.7.3
- **Jest**: 29.7.0 (테스트)

## 설치 및 실행

### 의존성 설치

```bash
npm install
```

### 서버 실행

```bash
npm run start:dev
```

### 테스트 실행

```bash
npm run test:cov
```

## API 문서

서버 실행 후 다음 URL에서 Swagger API 문서를 확인할 수 있습니다:

- http://localhost:3000/api

## 비즈니스 프로세스

![DEX Simulator Business Process](asset/process.png)

## 주요 기능

### 1. Market Module (시장 모듈)

- **가격 시뮬레이션**: ETH/BTC 가격 변동 시뮬레이션
- **변동성 계산**: 표준편차 기반 변동성 계산
- **아비트라지 기회 탐지**: 풀과 시장 가격 차이 기반 아비트라지 기회 계산
- **시장 상태 조회**: 현재 가격, 변동성, 아비트라지 기회 정보 제공

### 2. LP Module (유동성 공급자 모듈)

- **풀 생성**: ETH/BTC 유동성 풀 생성 및 관리
- **유동성 공급**: LP 토큰 발행 및 유동성 추가
- **유동성 제거**: LP 토큰 소각 및 유동성 회수
- **수수료 계산**: 거래 수수료 및 LP 수익 계산
- **풀 상태 조회**: 풀 정보, 유동성, 수수료 현황 조회

### 3. Trader Module (트레이더 모듈)

- **랜덤 거래**: ETH ↔ BTC 랜덤 거래 실행
- **아비트라지 거래**: 가격 차이를 이용한 수익 거래

## 프로젝트 구조

```
src/
├── common/           # 공통 모듈
│   ├── events/       # 이벤트 정의
│   └── filters/      # 예외 필터
├── lp/              # 유동성 공급자 모듈
├── market/          # 시장 모듈
├── trader/          # 트레이더 모듈
└── main.ts          # 애플리케이션 진입점
```

## 이벤트 시스템

- **market.price.changed**: 가격 변동 이벤트
- **arbitrage.opportunity**: 아비트라지 기회 발견 이벤트
- **trade.executed**: 거래 실행 이벤트

## 동적 수수료 시스템 (Dynamic Fee System)

### 기본 원리

DEX 시뮬레이터는 풀 크기와 시장 변동성에 따라 수수료를 동적으로 조절하는 시스템을 구현했습니다. 이는 유동성 공급자에게는 풀 성장에 따른 보상을, 리스크 관리 측면에서는 변동성에 따른 적절한 수수료를 제공합니다.

### 수수료 조절 요소

#### 1. 풀 크기 기반 수수료 조절

- **기본 원리**: 풀이 클수록 수수료를 낮춰서 거래자들이 더 많이 거래하도록 유도
- **계산식**:
  ```
  풀크기비율 = 현재풀가치 / 초기풀가치
  풀크기배수 = max(0.1, 1 / √풀크기비율)
  ```
- **예시**: 풀이 2배 커지면 → 1/√2 ≈ 0.707 → 수수료 29% 감소
- **효과**: 낮은 수수료로 거래량 증가 → 유동성 공급자들의 총 수수료 수익 증가

#### 2. 변동성 기반 수수료 조절

- **기본 원리**: 시장 변동성이 높을수록 수수료를 높여서 리스크 관리
- **계산식**:
  ```
  변동성배수 = 1 + (변동성% / 100) × 2
  ```
- **예시**: 변동성 5% → 1 + (5/100) × 2 = 1.10 → 수수료 10% 증가
- **효과**: 높은 변동성 시 거래자들에게 적절한 리스크 프리미엄 부과

#### 3. 복합 수수료 계산

- **가중치**: 풀 크기 60%, 변동성 40%
- **최종 계산식**:
  ```
  복합배수 = (풀크기배수 × 0.6) + (변동성배수 × 0.4)
  동적수수료 = 기본수수료(0.3%) × 복합배수
  최종수수료 = max(0.05%, min(1%, 동적수수료))
  ```
- **목적**: 유동성 공급자 보상과 리스크 관리의 균형
- **범위**: 최소 0.05% ~ 최대 1% (기본 0.3%)

### 동작 과정

1. **시장 가격 변동 감지**: Market 모듈에서 ETH/BTC 가격 변동 시뮬레이션
2. **변동성 계산**: 표준편차 기반으로 시장 변동성 측정
3. **이벤트 발생**: `market.price.changed` 이벤트로 LP 모듈에 알림
4. **수수료 재계산**: 풀 크기와 변동성을 종합하여 새로운 수수료율 계산
5. **거래 적용**: 다음 거래부터 새로운 수수료율 적용

### 실제 시나리오 예시

#### 시나리오 1: 풀 성장

- 초기 풀: 1000 ETH + 30000 BTC
- 성장 후: 2000 ETH + 60000 BTC (2배 증가)
- 결과: 수수료 0.3% → 0.247% (17% 감소)

#### 시나리오 2: 변동성 증가

- 시장 변동성: 5% 증가
- 결과: 수수료 0.3% → 0.312% (4% 증가)

#### 시나리오 3: 복합 상황

- 풀 크기: 2배 증가
- 변동성: 3% 증가
- 결과: 수수료 0.3% → 0.279% (7% 감소)

### 비즈니스 가치

- **유동성 공급자**: 낮은 수수료율이지만 거래량 증가로 총 수익 증대
- **거래자**: 풀이 클수록 낮은 수수료로 거래 비용 절약, 변동성 낮을 때 추가 혜택
- **시스템 안정성**: 변동성 증가 시 높은 수수료로 리스크 관리
- **경제적 인센티브**: 유동성 공급 증가 → 거래량 증가 → 수수료 수익 증대의 선순환 구조

## 테스트 커버리지

현재 프로젝트의 테스트 커버리지:

- **market.service.ts**: 100% 커버리지 달성
- **lp.service.ts**: 포괄적인 단위 테스트 및 통합 테스트
- **trader.service.ts**: 거래 로직 및 아비트라지 테스트
- **전체 프로젝트**: TypeScript 기반 테스트 구조 및 100% 커버리지 목표
